name: Build Android APK (Kivy/Buildozer)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_SDK_ROOT: /home/runner/android-sdk
      ANDROID_HOME: /home/runner/android-sdk

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git zip unzip curl \
            autoconf automake libtool pkg-config cmake \
            libffi-dev libssl-dev zlib1g-dev liblzma-dev \
            libsqlite3-dev libgdbm-dev libreadline-dev libbz2-dev \
            libncurses5-dev libncursesw5-dev libtinfo6 \
            libjpeg-dev libpng-dev
          sudo apt-get clean

      - name: Install Android commandline-tools (sdkmanager) + legacy shim
        run: |
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd /tmp

          # Command line tools oficiais
          curl -sSLo cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip

          rm -rf cmdline-tools
          unzip -q cmdline-tools.zip

          rm -rf "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          mv cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"

          # PATH para este step + prÃ³ximos
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
          echo "$ANDROID_SDK_ROOT/platform-tools" >> "$GITHUB_PATH"

          # ðŸ”¥ Compatibilidade: buildozer/p4a antigo procura tools/bin/sdkmanager
          mkdir -p "$ANDROID_SDK_ROOT/tools/bin"
          ln -sf "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
          ln -sf "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/avdmanager" "$ANDROID_SDK_ROOT/tools/bin/avdmanager"

          sdkmanager --version
          "$ANDROID_SDK_ROOT/tools/bin/sdkmanager" --version

      - name: Detect android.api from buildozer.spec (auto)
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          p = Path("buildozer.spec")
          if not p.exists():
              raise SystemExit("buildozer.spec nÃ£o encontrado na raiz do repositÃ³rio.")

          txt = p.read_text(encoding="utf-8", errors="ignore")
          # pega android.api = N
          m = re.search(r"(?m)^\s*android\.api\s*=\s*(\d+)\s*$", txt)
          android_api = m.group(1) if m else "33"

          # salva em env do GitHub Actions
          with open("/home/runner/work/_temp/android_env", "w") as f:
              f.write(f"ANDROID_API={android_api}\n")

          print("ANDROID_API =", android_api)
          PY
          cat /home/runner/work/_temp/android_env >> "$GITHUB_ENV"

      - name: Accept licenses + install required SDK packages (AIDL / build-tools)
        run: |
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # Aceita licenÃ§as (sem pipefail pra nÃ£o quebrar por broken pipe)
          yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses >/dev/null || true

          # Instala o SDK que o buildozer.spec pede
          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "build-tools;33.0.2" \
            "build-tools;36.1.0"

      - name: Fix buildozer.spec (CRLF -> LF + forÃ§a android.sdk_path)
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          p = Path("buildozer.spec")
          text = p.read_text(encoding="utf-8", errors="ignore")
          text = text.replace("\r\n", "\n").replace("\r", "\n")  # CRLF -> LF

          def set_key(section, key, value, text):
              sec_pat = re.compile(rf"(?ms)^\[{re.escape(section)}\]\n(.*?)(?=^\[|\Z)")
              m = sec_pat.search(text)
              if not m:
                  text = f"[{section}]\n\n" + text
                  m = sec_pat.search(text)

              body = m.group(1)
              key_pat = re.compile(rf"(?m)^{re.escape(key)}\s*=.*$")
              if key_pat.search(body):
                  body2 = key_pat.sub(f"{key} = {value}", body)
              else:
                  body2 = body + f"\n{key} = {value}\n"

              new_block = f"[{section}]\n" + body2
              return text[:m.start()] + new_block + text[m.end():]

          sdk_root = "/home/runner/android-sdk"
          text = set_key("app", "android.sdk_path", sdk_root, text)

          p.write_text(text.strip() + "\n", encoding="utf-8")
          print("buildozer.spec ajustado (LF + android.sdk_path).")
          PY

      - name: Install Buildozer
        run: |
          python -m pip install --upgrade pip wheel setuptools
          python -m pip install --upgrade buildozer Cython==0.29.36


      - name: Prefetch p4a sources (avoid 502)
        run: |
          set -e
          PKG_DIR="$HOME/.buildozer/android/packages"
          mkdir -p "$PKG_DIR"
          cd "$PKG_DIR"

          # Freetype (Kivy/SDL2 dependency) - Savannah can return 502 sometimes, so use a mirror.
          if [ ! -f "freetype-2.10.1.tar.gz" ]; then
            echo "Downloading freetype-2.10.1.tar.gz to $PKG_DIR ..."
            URLS=(
              "https://download.sourceforge.net/project/freetype/freetype2/2.10.1/freetype-2.10.1.tar.gz"
              "https://downloads.sourceforge.net/project/freetype/freetype2/2.10.1/freetype-2.10.1.tar.gz"
              "https://download.savannah.gnu.org/releases/freetype/freetype-2.10.1.tar.gz"
            )
            for u in "${URLS[@]}"; do
              echo "  -> $u"
              if curl -fL --retry 10 --retry-all-errors --retry-delay 2 --connect-timeout 20 --max-time 600 -o freetype-2.10.1.tar.gz "$u"; then
                break
              fi
            done
          fi

          ls -lh freetype-2.10.1.tar.gz
      - name: Build APK (debug)
        run: |
          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          export CONFIG_SITE="$GITHUB_WORKSPACE/android/config.site"
          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: |
            bin/*.apk
            bin/*.aab
          if-no-files-found: error

      - name: Upload build logs (se existir)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-logs
          path: |
            .buildozer/*.log
            .buildozer/android/platform/python-for-android/**/*.log
            .buildozer/android/platform/python-for-android/**/build.log
          if-no-files-found: ignore

name: Build Android APK (Kivy/Buildozer)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential git zip unzip curl \
            libffi-dev libssl-dev liblzma-dev zlib1g-dev \
            libsqlite3-dev libncurses5-dev libncursesw5-dev \
            libreadline-dev libbz2-dev libjpeg-dev \
            python3-setuptools python3-wheel
          python -m pip install -U pip setuptools wheel

      - name: Install Buildozer
        run: |
          python -m pip install "Cython==0.29.36" "buildozer==1.5.0"

      - name: Install Android cmdline-tools + SDK/NDK (and accept licenses)
        run: |
          set -euxo pipefail
          SDKROOT="/usr/local/lib/android/sdk"
          sudo mkdir -p "$SDKROOT/cmdline-tools"
          sudo chown -R "$USER":"$USER" "$SDKROOT"

          if [ ! -x "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            cd /tmp
            curl -L -o cmdline-tools.zip https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
            rm -rf cmdline-tools
            unzip -q cmdline-tools.zip
            rm -f cmdline-tools.zip
            rm -rf "$SDKROOT/cmdline-tools/latest"
            mkdir -p "$SDKROOT/cmdline-tools/latest"
            mv cmdline-tools/* "$SDKROOT/cmdline-tools/latest/"
          fi

          SDKMANAGER="$SDKROOT/cmdline-tools/latest/bin/sdkmanager"
          chmod +x "$SDKMANAGER"

          # aceita licenças (não falha o job se sdkmanager retornar nonzero)
          yes | "$SDKMANAGER" --sdk_root="$SDKROOT" --licenses || true

          # instala o necessário (Build-tools 33.0.2) + tenta também 36.1.0 (caso o p4a peça)
          "$SDKMANAGER" --sdk_root="$SDKROOT" \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            "ndk;25.1.8937393"

          "$SDKMANAGER" --sdk_root="$SDKROOT" "build-tools;36.1.0" || true

          # expõe no PATH
          echo "$SDKROOT/platform-tools" >> "$GITHUB_PATH"
          echo "$SDKROOT/cmdline-tools/latest/bin" >> "$GITHUB_PATH"

          # Define env pro Buildozer (evita ele baixar SDK próprio e travar em licença)
          echo "ANDROID_SDK_ROOT=$SDKROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$SDKROOT" >> "$GITHUB_ENV"
          echo "ANDROIDSDK=$SDKROOT" >> "$GITHUB_ENV"

          NDK_DIR="$SDKROOT/ndk/25.1.8937393"
          echo "ANDROIDNDK=$NDK_DIR" >> "$GITHUB_ENV"
          echo "ANDROID_NDK_HOME=$NDK_DIR" >> "$GITHUB_ENV"

      - name: Python sanity (only your code)
        run: |
          python -m compileall -q main.py core service

      - name: Build APK (debug)
        env:
          # garante que Buildozer use o SDK do sistema
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROIDSDK: ${{ env.ANDROIDSDK }}
          ANDROIDNDK: ${{ env.ANDROIDNDK }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          rm -rf .buildozer
          buildozer -v android debug

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk
          path: |
            bin/*.apk
            buildozer.log
